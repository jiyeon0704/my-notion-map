<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ë…¸ì…˜ ì„ë² ë“œìš© í•€ ì§€ë„ (Leaflet + Firestore)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  
<script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /********** 1. ë°°ê²½ ì´ë¯¸ì§€ URL **********/
    const MAP_IMAGE_URL = "https://jiyeon0704.github.io/info_map/mapsarboretum.png";

    /********** 2. ì§€ë„ ì˜µì…˜ **********/
    const MIN_ZOOM = -5;
    const MAX_ZOOM = 5;

    /********** 3. Firebase ì„¤ì • (âœ… ì¤‘ìš”! ì„¤ì • ì™„ë£Œ) **********/
    // 1. Firebase ì½˜ì†”ì—ì„œ 'ì›¹ ì•±'ì˜ ì„¤ì • ê°ì²´ë¥¼ ë³µì‚¬í•´ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
    // (ì´ íŒŒì¼ì€ ì™¸ë¶€ì— í˜¸ìŠ¤íŒ…ë˜ë¯€ë¡œ, Canvas ë³€ìˆ˜ ëŒ€ì‹  ì‹¤ì œ ê°’ì„ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.)
    const firebaseConfig = {
      apiKey: "AIzaSyB1r9RKhbbgXMvUFh3s69f1Lt5xIYr8t6U",
      authDomain: "infomap-52f57.firebaseapp.com",
      projectId: "infomap-52f57",
      storageBucket: "infomap-52f57.firebasestorage.app",
      messagingSenderId: "1039788996752",
      appId: "1:1039788996752:web:1ebca93b29d79033638015",
      measurementId: "G-WSB5TL789R"
    };
    
    // 2. ì´ ì§€ë„ì˜ í•€ì„ ì €ì¥í•  Firestore ì»¬ë ‰ì…˜ ì´ë¦„ì…ë‹ˆë‹¤.
    // (ë°ì´í„°ëŠ” ì´ ì»¬ë ‰ì…˜ì— ì €ì¥ë©ë‹ˆë‹¤.)
    const COLLECTION_PATH = 'infomap_pins'; // (ì´ë¦„ ë³€ê²½ ê°€ëŠ¥)

    /********** 4. ì „ì—­ ë³€ìˆ˜ **********/
    let map;
    const markerMap = new Map(); // id -> { marker, el, data }
    let selectedId = null;

    // ì´ë¯¸ì§€ í¬ê¸° ìë™ ì¸ì‹
    function getImageSize(url){
      return new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => res({ w: img.naturalWidth, h: img.naturalHeight });
        img.onerror = () => rej(new Error("ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."));
        img.src = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
      });
    }

    // ì»¤ìŠ¤í…€ ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„±
    function createMarkerIcon(titleText) {
      const root = document.createElement('div');
      root.className = 'marker-root';
      const dot = document.createElement('div');
      dot.className = 'marker-dot';
      const label = document.createElement('div');
      label.className = 'marker-label';
      label.textContent = titleText || '(ì œëª©ì—†ìŒ)';
      root.appendChild(label);
      root.appendChild(dot);
      return L.divIcon({
        html: root.outerHTML,
        className: '',
        iconSize: [22, 22],
        iconAnchor: [11, 11]
      });
    }

    // í•€ ì„ íƒ (í¬ì»¤ìŠ¤ ê¸°ëŠ¥)
    function selectMarker(id) {
      if (selectedId && markerMap.has(selectedId)) {
        const prevRec = markerMap.get(selectedId);
        if (prevRec.el) prevRec.el.classList.remove('marker-selected');
        const liPrev = document.querySelector(`#pinItems li[data-id="${selectedId}"]`);
        if (liPrev) liPrev.classList.remove('active');
      }
      
      selectedId = id;
      const titleInput = document.getElementById('title');
      
      if (markerMap.has(id)) {
        const rec = markerMap.get(id);
        if(rec.el) rec.el.classList.add('marker-selected');
        const li = document.querySelector(`#pinItems li[data-id="${id}"]`);
        if (li) li.classList.add('active');
        
        titleInput.value = rec.data.title || '';
        titleInput.focus();
      } else {
        titleInput.value = '';
      }
    }

    // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    function refreshList() {
      const listEl = document.getElementById('pinItems');
      if (!listEl) return;
      listEl.innerHTML = '';
      
      const arr = Array.from(markerMap.entries())
        .map(([id, rec]) => ({ id, ...rec }))
        .sort((a, b) => (a.data.title || '').localeCompare(b.data.title || ''));
        
      for (const item of arr) {
        const li = document.createElement('li');
        li.dataset.id = item.id;
        li.className = (item.id === selectedId) ? 'active' : '';
        
        const titleBtn = document.createElement('span');
        titleBtn.className = 'title';
        titleBtn.textContent = item.data.title || '(ì œëª©ì—†ìŒ)';
        titleBtn.addEventListener('click', () => {
          selectMarker(item.id);
          map.flyTo([item.data.lat, item.data.lng], map.getZoom(), { duration: 0.7 });
        });
        
        const coords = document.createElement('span');
        coords.className = 'coords';
        coords.textContent = `y: ${Number(item.data.lat).toFixed(2)}, x: ${Number(item.data.lng).toFixed(2)}`;
        
        li.appendChild(titleBtn);
        li.appendChild(coords);
        listEl.appendChild(li);
      }
    }

    // ë§ˆì»¤ ì¶”ê°€
    function addMarkerFromDoc(id, data, db) {
      if (markerMap.has(id)) return;
      const icon = createMarkerIcon(data.title);
      const marker = L.marker([data.lat, data.lng], { icon: icon, draggable: true }).addTo(map);
      const rootEl = marker.getElement();
      rootEl.dataset.markerId = id;
      
      marker.on('click', (e) => {
        L.DomEvent.stopPropagation(e);
        selectMarker(id);
      });
      marker.on('contextmenu', async (e) => {
        L.DomEvent.preventDefault(e);
        // [ìˆ˜ì •] Firestore ë³´ì•ˆ ê·œì¹™ì„ ê³ ë ¤í•˜ì—¬, ìµëª… ì‚¬ìš©ìë„ ì‚­ì œí•  ìˆ˜ ìˆë„ë¡ 
        // í™•ì¸ì°½ ì—†ì´ ë°”ë¡œ ì‚­ì œí•©ë‹ˆë‹¤.
        await deleteDoc(doc(db, COLLECTION_PATH, id));
      });
      marker.on('dragend', async () => {
        const p = marker.getLatLng();
        await updateDoc(doc(db, COLLECTION_PATH, id), { lat: p.lat, lng: p.lng, updatedAt: serverTimestamp() });
      });
      markerMap.set(id, { marker, el: rootEl, data });
    }

    // ë§ˆì»¤ ì—…ë°ì´íŠ¸
    function updateMarkerFromDoc(id, data) {
      const rec = markerMap.get(id);
      if (!rec) { addMarkerFromDoc(id, data); return; }
      
      rec.data = data;
      rec.marker.setLatLng([data.lat, data.lng]);
      const newIcon = createMarkerIcon(data.title);
      rec.marker.setIcon(newIcon);
      rec.el = rec.marker.getElement();
      rec.el.dataset.markerId = id;
      
      if (selectedId === id) {
        document.getElementById('title').value = data.title || '';
        rec.el.classList.add('marker-selected');
      }
    }

    // ë§ˆì»¤ ì‚­ì œ
    function removeMarker(id) {
      const rec = markerMap.get(id);
      if (!rec) return;
      rec.marker.remove();
      markerMap.delete(id);
      if (selectedId === id) {
        selectedId = null;
        document.getElementById('title').value = '';
      }
    }

    // ì•± ì´ˆê¸°í™” (Firestore ì—°ë™)
    function initFirestoreApp(db) {
      // 1. ë§µ í´ë¦­
      map.on('click', async (e) => {
        if (e.originalEvent.target.closest('.leaflet-marker-icon')) return;
        await addDoc(collection(db, COLLECTION_PATH), {
          title: '',
          lat: e.latlng.lat,
          lng: e.latlng.lng,
          updatedAt: serverTimestamp()
        });
      });

      // 2. 'Enter'ë¡œ ì œëª© ì €ì¥
      const titleInput = document.getElementById('title');
      titleInput.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          if (!selectedId) return;
          const title = titleInput.value.trim();
          await updateDoc(doc(db, COLLECTION_PATH, selectedId), { title, updatedAt: serverTimestamp() });
          titleInput.blur();
          const oldColor = titleInput.style.borderColor;
          titleInput.style.borderColor = "#22c55e";
          setTimeout(() => { titleInput.style.borderColor = oldColor; }, 1000);
        }
      });
      
      // 3. ì‹¤ì‹œê°„ êµ¬ë…
      const q = query(collection(db, COLLECTION_PATH));
      onSnapshot(q, (snap) => {
        snap.docChanges().forEach((ch) => {
          const id = ch.doc.id;
          const d  = ch.doc.data();
          if (ch.type === 'added') {
            addMarkerFromDoc(id, d, db);
            selectMarker(id); // ì¶”ê°€ë˜ë©´ ìë™ ì„ íƒ
          }
          else if (ch.type === 'modified') updateMarkerFromDoc(id, d);
          else if (ch.type === 'removed')  removeMarker(id);
        });
        refreshList();
      });
    }

    // ë©”ì¸ ë¡œì§ ì‹¤í–‰
    (async function start(){
      try {
        const { w: IMG_W, h: IMG_H } = await getImageSize(MAP_IMAGE_URL);
        map = L.map('map', {
          crs: L.CRS.Simple, minZoom: MIN_ZOOM, maxZoom: MAX_ZOOM,
          zoomSnap: 0.1, zoomDelta: 0.1, zoomControl: true,
          scrollWheelZoom: true, doubleClickZoom: true, boxZoom: true,
          dragging: true, touchZoom: true, keyboard: true
        });
        const bounds = [[0, 0], [IMG_H, IMG_W]];
        L.imageOverlay(MAP_IMAGE_URL, bounds, { interactive: false }).addTo(map);
        map.fitBounds(bounds);
        map.setMaxBounds(bounds);
        map.options.maxBoundsViscosity = 0.9;

        // 5. Firebase ì¸ì¦ (ì™¸ë¶€ í˜¸ìŠ¤íŒ…ìš©)
        if (!firebaseConfig.apiKey || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            console.error("Firebase ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.");
            document.getElementById('panel').innerHTML = "<h2>ì˜¤ë¥˜</h2><p>Firebase ì„¤ì •ì´ ëˆ„ë½ë˜ì–´ í•€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (HTML íŒŒì¼ ìˆ˜ì • í•„ìš”)</p>";
            return;
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); 

        // Canvas í™˜ê²½ì´ ì•„ë‹ˆë¯€ë¡œ í•­ìƒ ìµëª… ë¡œê·¸ì¸ ì‚¬ìš©
        await signInAnonymously(auth);

        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log("Firebase ì¸ì¦ ì„±ê³µ (ìµëª…):", user.uid);
            initFirestoreApp(db); // ì¸ì¦ ì„±ê³µ í›„ í•€ ê¸°ëŠ¥ ì´ˆê¸°í™”
          } else {
            console.log("Firebase ì¸ì¦ ì‹¤íŒ¨");
          }
        });

      } catch (e) {
        const errorDiv = `
          <div style="padding: 20px; text-align: center; font-family: sans-serif; color: #b91c1c; background: #fef2f2; height: 100%;">
            <h2>ì§€ë„ ë¡œë“œ ì˜¤ë¥˜</h2>
            <p>ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•˜ì„¸ìš”.</p>
            <pre style="text-align: left; background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #fecaca; overflow: auto;">${e.message}</pre>
          </div>`;
        document.getElementById('map').innerHTML = errorDiv;
        console.error(e);
      }
    })();
  
  </script>

  <style>
    /* ... (ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼) ... */
    html, body { height: 100%; margin: 0; }
    #app { display: flex; height: 100%; }
    #map { flex: 1; background: #ffffff !important; height: 100%; }
    #panel {
      width: 360px; background: #fff; padding: 12px 14px;
      border-left: 1px solid #e5e7eb; box-shadow: -2px 0 6px rgba(0,0,0,.05);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; font-size: 14px;
      display:flex; flex-direction:column; gap:10px;
      overflow-y: auto;
      flex-shrink: 0;
    }
    #panel h2 { margin: 4px 0 0; font-size: 16px; }
    .row { display:flex; flex-direction: column; gap:6px; }
    .row label { font-weight: 600; }
    .row input {
      padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;
      box-sizing: border-box;
      transition: border-color 0.2s ease-in-out;
    }
    .row input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb;
      outline: none;
    }
    .hint { color:#6b7280; font-size:12px; }
    .leaflet-marker-icon .marker-root { 
      width: 22px; height: 22px; 
      position: relative; cursor: pointer; 
    }
    .marker-dot {
      width: 14px; height: 14px; border-radius: 50%;
      background: #2563eb; border: 2px solid #ffffff; box-shadow: 0 0 0 1px #1f2937;
      position: absolute; left: 50%; top: 50%; 
      transform: translate(-50%, -50%); 
    }
    .marker-label {
      position: absolute; top: -26px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.9); border: 1px solid #e5e7eb; border-radius: 6px;
      padding: 2px 6px; font-size: 12px; font-weight: 600; color: #111827;
      white-space: nowrap; pointer-events: none;
    }
    .leaflet-marker-icon .marker-selected .marker-dot,
    .leaflet-marker-icon:hover .marker-dot { 
      background: #ef4444; 
    }
    .leaflet-marker-icon .marker-selected { z-index: 1000 !important; }
    #pinList { border-top:1px solid #e5e7eb; padding-top:8px; }
    #pinItems { list-style:none; padding:0; margin:0; max-height:240px; overflow:auto; }
    #pinItems li {
      display:flex; align-items:center; justify-content:space-between;
      gap:8px; padding:6px 4px; border-bottom:1px dashed #eef2f7;
    }
    #pinItems li .title { cursor:pointer; }
    #pinItems li .coords { color:#6b7280; font-size:12px; }
    #pinItems li.active .title { font-weight:700; color:#ef4444; }
  </style>
</head>
<body>

<div id="app">
  <div id="map" aria-label="ìˆ˜ëª©ì› ì´ë¯¸ì§€ ì§€ë„"></div>
  <div id="panel">
    <h2>ğŸŒ¿ ì•ˆë‚´íŒ ìœ„ì¹˜</h2> 
    <div class="row">
      <span class="hint">ì§€ë„ì˜ ë¹ˆ ê³³ì„ í´ë¦­í•˜ë©´ ìƒˆ í•€ì´ ìƒì„±ë©ë‹ˆë‹¤. í•€ì„ í´ë¦­í•˜ë©´ ì„ íƒë©ë‹ˆë‹¤. í•€ì„ ë“œë˜ê·¸í•˜ì—¬ ì˜®ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
      <label for="title">ì œëª© (ì„ íƒ í›„ 'Enter'ë¡œ ì €ì¥)</label>
      <input id="title" placeholder="ì˜ˆ: ì†Œë‚˜ë¬´ ì•ˆë‚´íŒ" />
    </div>
    <div id="pinList">
      <h3 style="margin:0 0 6px 0; font-size:15px;">ğŸ“ í•€ ëª©ë¡</h3>
      <ul id="pinItems"></ul>
    </div>
    <div class="row"><span class="hint">íŒ: ëª©ë¡ì˜ ì œëª©ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™í•©ë‹ˆë‹¤. í•€ì„ ìš°í´ë¦­í•˜ë©´ ë°”ë¡œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span></div>
  </div>
</div>

</body>
</html>